name: Run App, Test and Cleanup

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  run_app:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat <<EOF > .env
          DB_NAME=gg
          DB_USER=gleb
          DB_PASS=1234
          DB_HOST=db
          DB_PORT=5432
          TEST_DB_NAME=gg_test
          TEST_DB_USER=gleb_test
          TEST_DB_PASS=1234
          TEST_DB_HOST=db_test
          TEST_DB_PORT=5430
          EOF

      - name: Build and run containers
        run: docker-compose up -d

      - name: Wait for services to initialize
        run: sleep 10

      - name: Run tests in backend container
        run: docker-compose exec -T backend pytest --maxfail=1 --disable-warnings -q

      - name: Tear down containers and remove volumes
        run: docker-compose down -v

      - name: Auto-cleanup Docker system
        run: docker system prune -f --volumes
